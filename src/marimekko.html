<!DOCTYPE html>
<meta charset="utf-8">
<html>
    <head>
        <script src="js/d3.v3.min.js"></script>
        <script src="js/jquery-1.11.0.min.js"></script>
    </head>
    <body>
        <script>
            var width = 960,
            height = 900,
            margin = 30,
            color = d3.scale.category10(),
            n = d3.format(",d"),
            p = d3.format("%");
            
            // dit moet eruit zien als http://www.jasondavies.com/mekko/ maar er gaat nog iets mis met de zwarte lijntjes
            
            d3.tsv("data/SPPA82-12-filtered.tsv", function(data) {
                
                var nest = d3.nest()
                    .key(function(d) { return d.jazz; })
                    .key(function(d) { return d.education; })
                    .rollup(function(leaves) { return [{ "value": leaves.length }] })
                    .entries(data);
                
                nest.forEach(function(jazz) {
                    jk = jazz.key;
                    jazz.values.forEach(function(income) {
                        income.values.forEach(function(value) {
                            value.jazz = jk;
                        })
                    })
                });
                
                // filter only yes and no (no don't know or refused)
                nest = nest.filter(function(d) { return d.key == "yes" || d.key == "no" });
                
                // waarom zijn x, y, dx en dy hier al geset?!?!?
                console.log(nest);
                
                var treemap = d3.layout.treemap()
                    .mode("slice-dice")
                    .size([width - 3 * margin, height - 2 * margin])
                    .children(function(d) { return d.values; })
                    .sort(null);
                
                var svg = d3.select("body").append("svg")
                    .attr("width", width)
                    .attr("height", height)
                    .append("g")
                    .attr("transform", "translate(" + 2 * margin + "," + margin + ")")
                    .datum({values: nest})
                    .call(chart);
                
                svg.append("g")
                    .attr("class", "x axis")
                    .attr("transform", "translate(0," + treemap.size()[1] + ")")
                    .call(d3.svg.axis().scale(d3.scale.linear().range([0, treemap.size()[0]])).tickFormat(d3.format("%")));
        
                svg.append("g")
                    .attr("class", "y axis")
                    .call(d3.svg.axis().scale(d3.scale.linear().range([treemap.size()[1], 0])).tickFormat(d3.format("%")).orient("left"));
                
                function chart(selection) {
                  selection.each(function() {
                    var cell = d3.select(this).selectAll("g.cell")
                        .data(treemap.nodes);
                    var cellEnter = cell.enter().append("g")
                        .attr("class", "cell");
                    var cellUpdate = d3.transition(cell)
                        .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
                    d3.transition(cell.exit()).remove();
                
                    cellEnter.filter(function(d) { return d.depth > 2; }).append("rect")
                        .style("fill", function(d) { return d.children ? null : color(d.jazz); });
                    cellUpdate.select("rect")
                        .attr("width", function(d) { return d.dx; })
                        .attr("height", function(d) { return d.dy; })
                
                    cellEnter.append("title")
                        .text(function(d) { return d.children ? null : title(d); });
                  });
                }
                
                function title(d) {
                    return d.jazz + ": " + d.parent.key + ": " + n(d.value);
                } 
            });

        </script>
    </body>
</html>