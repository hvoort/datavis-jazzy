<!DOCTYPE html>
<meta charset="utf-8">
<html>
    <head>
        <script src="js/d3.v3.min.js"></script>
        <script src="js/topojson.v1.min.js"></script>
        <script src="js/jquery-1.11.0.min.js"></script>
        <script src="js/usmapvis.js"></script>
        <script src="js/piecharts.js"></script>
        <script type="text/javascript" src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css">
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap-theme.min.css">
        <link href="css/style.css" rel="stylesheet" type="text/css">
    </head>
    <body>
        <div id="pietooltip" class="tooltip" style="display:none;"></div>
        <div id="timeline_container">
            <div id="timeline"></div>
        </div>
        <div id="map1" class="map">
        </div>
        <div id="map2" class="map">
        </div>
        <div id="map3" class="map">
        </div>
        <div id="mapfilters" class="mapfilters"></div>
        <script>
            $(function () {
                var mapconfig = {
                        width: 400,
                        height: 300
                    };
                    map1 = usmapvis.createMap(d3.select("#map1"), mapconfig),
                    map2 = usmapvis.createMap(d3.select("#map2"), mapconfig),
                    map3 = usmapvis.createMap(d3.select("#map3"), mapconfig),
                    
                    generic_sum = function (prop) {
                       return function (group) {
                           return d3.sum(group.values, function(d) { 
                               if (d[prop] == "yes") { return 1; } 
                               else { return 0; } 
                            }) / group.values.length * 100
                        };
                    },
                    perc_tooltip = function(group, val) {
                        return group.name + "<br/>" + val.toFixed(2) + "%";
                    },
                    culturals = ["jazz", "classical", "opera", "musical", "play", "ballet", "dance", "artmuseum", "park", "books"],
                    comparable = ["income", "marital", "gender", "education", "race", "employed", "agegroup", "mother_educ", "father_educ"],
                    culturalcbs = [];
                
                    years = [2002, 2008, 2012];
                
                /**
                * TIMELINE
                */
                $("#timeline_container").css("width", mapconfig.width * 3 + 60 + "px");
                $.map(years, function (year) {
                    var $timeline = $("#timeline"),
                        $timeline_container = $("#timeline_container"),
                        min = Math.min.apply(null, years),
                        max = Math.max.apply(null, years),
                        span = max - min,
                        spanwidth = $timeline.width(),
                        spanpadding = 100,
                        position = Math.round(((year - min) / span) * (spanwidth - 2 * spanpadding)),
                        $div = $("<div />");
                    
                    $div.addClass("tooltip") // styling
                        .text(year)
                        .appendTo($timeline_container)
                        .css({
                            "top": "40px",
                            "left": $timeline.offset().left + position + spanpadding - $div.width() + "px"
                        });
                });
                
                map1.linkMaps([map2, map3]);
                map2.linkMaps([map1, map3]);
                map3.linkMaps([map1, map2]);                
                
                showStatistics = function() {
                    var selected = $("#mapfilters input[id^='cb']:checked").map(function(){
                      return $(this).val();
                    }).get();
                    map1.showStatistic(selected, ["" + years[0]], perc_tooltip);
                    map2.showStatistic(selected, ["" + years[1]], perc_tooltip);
                    map3.showStatistic(selected, ["" + years[2]], perc_tooltip);
                }
                
                culturals.forEach(function(cultural) {
                    usmapvis.createStatistic(cultural, generic_sum(cultural));
                    
                    var cb = $(document.createElement('input')).attr({
                        id: 'cb' + cultural,
                        value: cultural,
                        type: 'checkbox',
                        onclick: 'showStatistics()'
                        });
                    
                    culturalcbs.push(cb);
                    $("<label>")
                        .attr("for", "cb" + cultural)
                        .append(cb)
                        .append("&nbsp;Select " + cultural)
                        .appendTo($("#mapfilters"));
                });
                
                // Default show
                $("#mapfilters input[id^='cb']:eq(0)").attr("checked", true);
                showStatistics();
                
                /**
                *   COMPARE TOOL
                 */
                
                var compare = (function (num) {
                    var selected = [],
                        maps = [],
                        clickHandler = function(e, map, group, years) {
                            var new_select = {
                                    state: group,
                                    years: years
                                },
                                new_selected = $.grep(selected, function (select) {
                                    return !selectedEquals(select, new_select);
                                });
                            
                            // unselected
                            if (selected.length !== new_selected.length) {
                                selected = new_selected;
                                // remove pie
                            }
                            // selected
                            else {
                                selected.push(new_select);                                
                                // add pie
                                makePie(new_select.state, new_select.years, "education");
                            }
                        },
                        selectedEquals = function (s1, s2) {
                            return (s1.state.key == s2.state.key &&
                                        $(s1.years).not(s2.years).length == 0 && 
                                        $(s2.years).not(s1.years).length == 0)
                        },
                        setMaps = function (maps_in) {
                            $.extend(maps, maps_in);
                            
                            $.map(maps, function (map) {
                                map1.addClickStateFunction(clickHandler);
                            });
                        };                    
                    
                    return {
                        setMaps: setMaps
                    };
                }(3));
                
                compare.setMaps([map1, map2, map3]);
            });
            
        </script>
    </body>
</html>